#!/bin/bash
# ng-build - Build script for ng pi-gen images
# Usage: ng-build <config-name> [--continue] [--clean]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NG_DIR="$(dirname "$SCRIPT_DIR")"
PI_GEN_DIR="$(dirname "$NG_DIR")"

# Required config keys that must be defined
REQUIRED_KEYS=("NG_NETBIRD_SETUP_KEY")

# Default build options (preserve container by default)
export PRESERVE_CONTAINER=1
export CONTINUE=0
export CLEAN=0

# Parse arguments
CONFIG_NAME=""
for arg in "$@"; do
    case "$arg" in
        --continue|-c)
            export CONTINUE=1
            ;;
        --clean)
            export CLEAN=1
            ;;
        --help|-h)
            echo "Usage: $0 <config-name> [options]"
            echo ""
            echo "Options:"
            echo "  --continue, -c  Continue from existing container"
            echo "  --clean         Clean current stage and rebuild"
            echo "  --help, -h      Show this help"
            echo ""
            echo "Available configs:"
            ls -1 "$NG_DIR/configs/" 2>/dev/null || echo "  (none found)"
            exit 0
            ;;
        -*)
            echo "Unknown option: $arg"
            exit 1
            ;;
        *)
            if [ -z "$CONFIG_NAME" ]; then
                CONFIG_NAME="$arg"
            fi
            ;;
    esac
done

# Format seconds to human readable time
format_duration() {
    local total_seconds=$1
    local hours=$((total_seconds / 3600))
    local minutes=$(((total_seconds % 3600) / 60))
    local seconds=$((total_seconds % 60))
    
    if [ $hours -gt 0 ]; then
        printf "%dh %dm %ds" $hours $minutes $seconds
    elif [ $minutes -gt 0 ]; then
        printf "%dm %ds" $minutes $seconds
    else
        printf "%ds" $seconds
    fi
}

# Check for config argument
if [ -z "$CONFIG_NAME" ]; then
    echo "Usage: $0 <config-name> [--continue] [--clean]"
    echo "Available configs:"
    ls -1 "$NG_DIR/configs/" 2>/dev/null || echo "  (none found)"
    exit 1
fi

CONFIG_FILE="$NG_DIR/configs/$CONFIG_NAME"

# Verify config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Config '$CONFIG_NAME' not found at $CONFIG_FILE"
    exit 1
fi

echo "=== ng-build ==="
echo "Config: $CONFIG_NAME"
echo "Config file: $CONFIG_FILE"
[ "$CONTINUE" = "1" ] && echo "Mode: CONTINUE (resuming from existing container)"
[ "$CLEAN" = "1" ] && echo "Mode: CLEAN (rebuilding current stage)"
echo ""

# Source config to validate required keys
# Set BASE_DIR as build.sh would, so config can reference it
export BASE_DIR="$PI_GEN_DIR"
set -a
source "$CONFIG_FILE"
set +a

# Validate required keys
MISSING_KEYS=()
for key in "${REQUIRED_KEYS[@]}"; do
    if [ -z "${!key}" ]; then
        MISSING_KEYS+=("$key")
    fi
done

if [ ${#MISSING_KEYS[@]} -gt 0 ]; then
    echo "Error: Missing required config keys:"
    for key in "${MISSING_KEYS[@]}"; do
        echo "  - $key"
    done
    exit 1
fi
echo "✓ All required config keys present"
echo ""

# Create EXPORT_CONFIG_DIR if set and doesn't exist (copy from default)
if [ -n "${EXPORT_CONFIG_DIR:-}" ] && [ ! -d "$EXPORT_CONFIG_DIR" ]; then
    echo "Creating export config directory: $EXPORT_CONFIG_DIR"
    cp -r "$PI_GEN_DIR/export-image" "$EXPORT_CONFIG_DIR"
    echo "✓ Copied default export scripts to $EXPORT_CONFIG_DIR"
    echo ""
fi

# Docker container name
CONTAINER_NAME="${CONTAINER_NAME:-pigen_work}"

# Check if container exists
CONTAINER_EXISTS=$(docker ps -a --filter name="^${CONTAINER_NAME}$" -q 2>/dev/null || true)

# Helper function for yes/no prompts
ask_yes_no() {
    local prompt="$1"
    local default="${2:-n}"
    local answer
    if [ "$default" = "y" ]; then
        read -p "$prompt [Y/n]: " answer
        answer="${answer:-y}"
    else
        read -p "$prompt [y/N]: " answer
        answer="${answer:-n}"
    fi
    [[ "$answer" =~ ^[Yy] ]]
}

# Get list of stages from STAGE_LIST or default
get_stage_list() {
    if [ -n "${STAGE_LIST:-}" ]; then
        echo "$STAGE_LIST"
    else
        echo "stage0 stage1 stage2 stage3 stage4 stage5"
    fi
}

# Find stages with SKIP files (excluding stage3,4,5 which we always skip)
find_skip_stages() {
    local skipped=()
    for stage in stage0 stage1 stage2; do
        if [ -f "$PI_GEN_DIR/$stage/SKIP" ]; then
            skipped+=("$stage")
        fi
    done
    # Check ng stages
    for stage_path in "$NG_DIR"/stages/*/; do
        if [ -d "$stage_path" ] && [ -f "$stage_path/SKIP" ]; then
            skipped+=("$(basename "$stage_path")")
        fi
    done
    echo "${skipped[@]}"
}

# Handle container existence and CONTINUE flag
if [ -n "$CONTAINER_EXISTS" ]; then
    if [ "$CONTINUE" != "1" ]; then
        echo "⚠ Container '$CONTAINER_NAME' already exists."
        echo ""
        echo "Options:"
        echo "  1) Remove container and start fresh"
        echo "  2) Continue from existing container"
        echo "  3) Abort"
        echo ""
        read -p "Choose [1/2/3]: " choice
        case "$choice" in
            1)
                echo "Removing container..."
                docker rm -v "$CONTAINER_NAME"
                echo "✓ Container removed"
                export CONTINUE=0
                ;;
            2)
                export CONTINUE=1
                echo "✓ Continuing from existing container"
                ;;
            *)
                echo "Aborted."
                exit 1
                ;;
        esac
        echo ""
    fi
fi

# Check for existing stage work directories and SKIP files
check_existing_stages() {
    local work_base="${WORK_DIR:-$PI_GEN_DIR/work}"
    
    if [ ! -d "$work_base" ]; then
        return
    fi
    
    # Find stage directories that exist in work dir
    local existing_stages=()
    for stage_dir in "$work_base"/*/; do
        if [ -d "$stage_dir" ]; then
            existing_stages+=("$(basename "$stage_dir")")
        fi
    done
    
    if [ ${#existing_stages[@]} -eq 0 ]; then
        return
    fi
    
    echo "Found existing stage work directories:"
    for stage in "${existing_stages[@]}"; do
        local has_skip=""
        # Check ng/stages first, then pi-gen root
        if [ -d "$NG_DIR/stages/$stage" ]; then
            [ -f "$NG_DIR/stages/$stage/SKIP" ] && has_skip=" [SKIP]"
        elif [ -d "$PI_GEN_DIR/$stage" ]; then
            [ -f "$PI_GEN_DIR/$stage/SKIP" ] && has_skip=" [SKIP]"
        fi
        echo "  - $stage$has_skip"
    done
    echo ""
    
    if [ "$CONTINUE" != "1" ]; then
        # Fresh build - check for stale SKIP files
        echo "Starting fresh build. Checking for SKIP files to remove..."
        for stage in "${existing_stages[@]}"; do
            local skip_file=""
            # Check ng/stages first, then pi-gen root
            if [ -d "$NG_DIR/stages/$stage" ]; then
                skip_file="$NG_DIR/stages/$stage/SKIP"
            elif [ -d "$PI_GEN_DIR/$stage" ]; then
                skip_file="$PI_GEN_DIR/$stage/SKIP"
            fi
            
            if [ -n "$skip_file" ] && [ -f "$skip_file" ]; then
                if ask_yes_no "  Remove SKIP from $stage?"; then
                    rm -f "$skip_file"
                    echo "    ✓ Removed SKIP from $stage"
                fi
            fi
        done
        echo ""
    else
        # Continue mode - offer to add SKIP files
        echo "Continue mode: Select stages to SKIP (already completed):"
        echo "(Last stage listed is likely the failed one - consider rebuilding it)"
        echo ""
        
        local last_stage="${existing_stages[-1]}"
        
        for stage in "${existing_stages[@]}"; do
            local skip_file=""
            local is_last=""
            
            # Check ng/stages first, then pi-gen root
            if [ -d "$NG_DIR/stages/$stage" ]; then
                skip_file="$NG_DIR/stages/$stage/SKIP"
            elif [ -d "$PI_GEN_DIR/$stage" ]; then
                skip_file="$PI_GEN_DIR/$stage/SKIP"
            fi
            
            if [ "$stage" = "$last_stage" ]; then
                is_last=" ⚠ (likely failed - recommend rebuild)"
            fi
            
            if [ -n "$skip_file" ]; then
                if [ -f "$skip_file" ]; then
                    echo "  $stage: already has SKIP$is_last"
                else
                    if ask_yes_no "  Add SKIP to $stage?$is_last" "n"; then
                        touch "$skip_file"
                        echo "    ✓ Added SKIP to $stage"
                    fi
                fi
            fi
        done
        echo ""
        
        # Offer to set CLEAN if not already set
        if [ "$CLEAN" != "1" ]; then
            echo "CLEAN is not set. The failed stage will resume from its last state."
            if ask_yes_no "Set CLEAN=1 to rebuild the failed stage from scratch?"; then
                export CLEAN=1
                echo "✓ CLEAN enabled"
            else
                echo "  Proceeding without CLEAN (resuming failed stage)"
            fi
            echo ""
        fi
    fi
}

# Run the stage check
check_existing_stages

# Setup logging
TIMESTAMP=$(date "+%Y%m%d_%H%M%S")
LOG_DIR="$NG_DIR/logs/$CONFIG_NAME"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/${TIMESTAMP}.log"
echo "Log file: $LOG_FILE"
echo ""

# Setup Docker volume mounts for WORK_DIR and DEPLOY_DIR
# This ensures build artifacts are stored on host, not inside container
# Paths must be translated: host path -> container path (/pi-gen/...)
DOCKER_MOUNTS=""

# Function to convert host path to container path
# Replaces BASE_DIR prefix with /pi-gen
host_to_container_path() {
    local host_path="$1"
    echo "${host_path/$BASE_DIR//pi-gen}"
}

if [ -n "${WORK_DIR:-}" ]; then
    # Create work dir on host if it doesn't exist
    mkdir -p "$WORK_DIR"
    # Calculate container path (replace BASE_DIR with /pi-gen)
    CONTAINER_WORK_DIR=$(host_to_container_path "$WORK_DIR")
    DOCKER_MOUNTS="$DOCKER_MOUNTS --volume ${WORK_DIR}:${CONTAINER_WORK_DIR}"
    echo "✓ Mounting WORK_DIR: $WORK_DIR -> $CONTAINER_WORK_DIR"
fi

if [ -n "${DEPLOY_DIR:-}" ]; then
    # Create deploy dir on host if it doesn't exist
    mkdir -p "$DEPLOY_DIR"
    # Calculate container path (replace BASE_DIR with /pi-gen)
    CONTAINER_DEPLOY_DIR=$(host_to_container_path "$DEPLOY_DIR")
    DOCKER_MOUNTS="$DOCKER_MOUNTS --volume ${DEPLOY_DIR}:${CONTAINER_DEPLOY_DIR}"
    echo "✓ Mounting DEPLOY_DIR: $DEPLOY_DIR -> $CONTAINER_DEPLOY_DIR"
fi

# Export docker options with our mounts
export PIGEN_DOCKER_OPTS="${PIGEN_DOCKER_OPTS:-} $DOCKER_MOUNTS"

# Record start time
START_TIME=$(date +%s)
START_DATE=$(date "+%Y-%m-%d %H:%M:%S")
echo "Build started: $START_DATE"
echo ""

echo "Starting docker build..."
cd "$PI_GEN_DIR"

# Run build and capture exit code, tee to log file
set +e
./build-docker.sh -c "$CONFIG_FILE" 2>&1 | tee "$LOG_FILE"
BUILD_EXIT_CODE=${PIPESTATUS[0]}
set -e

# Calculate elapsed time
END_TIME=$(date +%s)
END_DATE=$(date "+%Y-%m-%d %H:%M:%S")
ELAPSED=$((END_TIME - START_TIME))
DURATION=$(format_duration $ELAPSED)

echo ""
echo "=========================================="
echo "Build finished: $END_DATE"
echo "Elapsed time: $DURATION"
echo ""

if [ $BUILD_EXIT_CODE -eq 0 ]; then
    echo "✓ BUILD SUCCEEDED"
    echo "=========================================="
    exit 0
else
    echo "✗ BUILD FAILED (exit code: $BUILD_EXIT_CODE)"
    echo "=========================================="
    exit $BUILD_EXIT_CODE
fi
